name: Lighthouse CI
on:
  workflow_call:
    inputs:
      preview_url:
        required: true
        type: string
        description: "The Vercel preview URL to audit"
      pr_number:
        required: false
        type: string
        description: "PR number to post comments to (optional, defaults to current PR)"
    secrets:
      LHCI_GITHUB_APP_TOKEN:
        required: true   # Required for Lighthouse CI
jobs:
  lighthouse:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout shared workflows repo
        uses: actions/checkout@v4
        with:
          repository: ion8/workflows
          path: .workflows
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
      - name: Run Lighthouse CI
        run: |
          yarn global add @lhci/cli
          echo "=== Verifying config file exists and content ==="
          cat .workflows/lighthouserc.json
          echo "=== Running LHCI with verbose output ==="
          lhci autorun --config=.workflows/lighthouserc.json --collect.url="${{ inputs.preview_url }}" --collect.startServerCommand="" --verbose
      - name: Post Lighthouse results to PR
        if: always() && (github.event_name == 'pull_request' || inputs.pr_number)
        run: |
          PR_NUMBER="${{ inputs.pr_number }}"
          # Find the Lighthouse report (only 1 run, so only 1 file)
          REPORT_FILE=$(find .lighthouseci -name "lhr-*.json" | head -1)
          
          if [ -f "$REPORT_FILE" ]; then
            # Parse scores using jq
            PERF=$(cat "$REPORT_FILE" | jq -r '.categories.performance.score * 100 | floor')
            A11Y=$(cat "$REPORT_FILE" | jq -r '.categories.accessibility.score * 100 | floor')
            BP=$(cat "$REPORT_FILE" | jq -r '.categories["best-practices"].score * 100 | floor')
            SEO=$(cat "$REPORT_FILE" | jq -r '.categories.seo.score * 100 | floor')
            LCP=$(cat "$REPORT_FILE" | jq -r '.audits["largest-contentful-paint"].displayValue')
            TBT=$(cat "$REPORT_FILE" | jq -r '.audits["total-blocking-time"].displayValue')
            CLS=$(cat "$REPORT_FILE" | jq -r '.audits["cumulative-layout-shift"].displayValue')
            # Determine emoji based on score
            get_emoji() {
              if [ $1 -ge 90 ]; then echo "ðŸŸ¢"
              elif [ $1 -ge 70 ]; then echo "ðŸŸ¡"
              else echo "ðŸ”´"
              fi
            }
            PERF_EMOJI=$(get_emoji $PERF)
            A11Y_EMOJI=$(get_emoji $A11Y)
            BP_EMOJI=$(get_emoji $BP)
            SEO_EMOJI=$(get_emoji $SEO)
            # Create comment body
            COMMENT_BODY="## ðŸš¦ Lighthouse CI Results
            | Category | Score |
            |----------|-------|
            | $PERF_EMOJI **Performance** | **${PERF}%** |
            | $A11Y_EMOJI **Accessibility** | **${A11Y}%** |
            | $BP_EMOJI **Best Practices** | **${BP}%** |
            | $SEO_EMOJI **SEO** | **${SEO}%** |
            ### Core Web Vitals
            - **LCP:** ${LCP}
            - **TBT:** ${TBT}
            - **CLS:** ${CLS}
            ---
            _Tested on: Homepage (/) â€¢ Commit: \`${GITHUB_SHA:0:7}\`_"
            # Find existing Lighthouse comment
            COMMENT_ID=$(gh api \
              "repos/${{ github.repository }}/issues/${PR_NUMBER}/comments" \
              --jq '.[] | select(.body | startswith("## ðŸš¦ Lighthouse CI Results")) | .id' \
              | head -1)
            if [ -n "$COMMENT_ID" ]; then
              # Update existing comment
              echo "Updating existing comment ID: $COMMENT_ID"
              gh api \
                --method PATCH \
                "repos/${{ github.repository }}/issues/comments/$COMMENT_ID" \
                -f body="$COMMENT_BODY"
            else
              # Create new comment
              echo "Creating new comment"
              gh api \
                --method POST \
                "repos/${{ github.repository }}/issues/${PR_NUMBER}/comments" \
                -f body="$COMMENT_BODY"
            fi
          else
            echo "No Lighthouse report found"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Upload Lighthouse results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-results
          path: .lighthouseci