name: Lighthouse CI
on:
  workflow_call:
    inputs:
      preview_url:
        required: true
        type: string
        description: "The Vercel preview URL to audit"
      pr_number:
        required: false
        type: string
        description: "PR number to post comments to (optional, defaults to current PR)"
    secrets:
      LHCI_GITHUB_APP_TOKEN:
        required: true   # Required for Lighthouse CI
jobs:
  lighthouse:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout shared workflows repo
        uses: actions/checkout@v4
        with:
          repository: ion8/workflows
          path: .workflows
          # ref: seema/branch-name # only add this when testing from a branch other than main
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
      - name: Run Lighthouse CI
        run: |
          set +e  # Don't exit on error immediately
          yarn global add @lhci/cli
          echo "=== Verifying config file exists and content ==="
          cat .workflows/lighthouserc.json
          echo "=== Running LHCI with verbose output ==="
          lhci autorun --config=.workflows/lighthouserc.json --collect.url="${{ inputs.preview_url }}" --collect.startServerCommand="" --verbose
          LHCI_EXIT_CODE=$?
          
          # Upload to temporary storage to get public report link (always run even if assertions failed)
          echo "=== Uploading to temporary public storage ==="
          UPLOAD_OUTPUT=$(lhci upload --target=temporary-public-storage 2>&1) || true
          REPORT_URL=$(echo "$UPLOAD_OUTPUT" | grep -oE 'https://storage\.googleapis\.com/[^[:space:]]+\.html' | head -1)
          echo "Report URL: $REPORT_URL"
          echo "REPORT_URL=$REPORT_URL" >> $GITHUB_ENV
          echo "LHCI_EXIT_CODE=$LHCI_EXIT_CODE" >> $GITHUB_ENV
          
          # Exit with the original exit code to mark step as failed if assertions failed
          exit $LHCI_EXIT_CODE
      - name: Post Lighthouse results to PR
        if: always() && (github.event_name == 'pull_request' || inputs.pr_number)
        run: |
          PR_NUMBER="${{ inputs.pr_number }}"
          # Find the median run report from manifest.json
          # We calculate the median from summary.performance scores since LHCI's
          # isRepresentativeRun uses a different algorithm than median-run assertions
          if [ -f ".lighthouseci/manifest.json" ]; then
            # Sort by performance score and pick the middle one (actual median)
            REPORT_FILE=$(cat .lighthouseci/manifest.json | jq -r '
              sort_by(.summary.performance) | 
              .[length/2 | floor] | 
              .jsonPath
            ')
            PERF_SCORE=$(cat .lighthouseci/manifest.json | jq -r '
              sort_by(.summary.performance) | 
              .[length/2 | floor] | 
              .summary.performance
            ')
            echo "Using median run with performance score: $PERF_SCORE"
            echo "Report file: $REPORT_FILE"
          else
            # Fallback to first report if manifest doesn't exist
            REPORT_FILE=$(find .lighthouseci -name "lhr-*.json" | head -1)
            echo "Warning: manifest.json not found, using first available report"
          fi
          
          if [ -f "$REPORT_FILE" ]; then
            # Parse scores using jq
            PERF=$(cat "$REPORT_FILE" | jq -r '.categories.performance.score * 100 | floor')
            A11Y=$(cat "$REPORT_FILE" | jq -r '.categories.accessibility.score * 100 | floor')
            BP=$(cat "$REPORT_FILE" | jq -r '.categories["best-practices"].score * 100 | floor')
            SEO=$(cat "$REPORT_FILE" | jq -r '.categories.seo.score * 100 | floor')
            LCP=$(cat "$REPORT_FILE" | jq -r '.audits["largest-contentful-paint"].displayValue')
            TBT=$(cat "$REPORT_FILE" | jq -r '.audits["total-blocking-time"].displayValue')
            CLS=$(cat "$REPORT_FILE" | jq -r '.audits["cumulative-layout-shift"].displayValue')
            # Determine emoji based on score
            get_emoji() {
              if [ $1 -ge 90 ]; then echo "üü¢"
              elif [ $1 -ge 70 ]; then echo "üü°"
              else echo "üî¥"
              fi
            }
            PERF_EMOJI=$(get_emoji $PERF)
            A11Y_EMOJI=$(get_emoji $A11Y)
            BP_EMOJI=$(get_emoji $BP)
            SEO_EMOJI=$(get_emoji $SEO)
            
            # Build report link line if URL exists
            if [ -n "$REPORT_URL" ]; then
              REPORT_LINK="<a href=\"$REPORT_URL\" target=\"_blank\">View Full Report</a>"
            else
              REPORT_LINK=""
            fi
            
            # Add warning note if assertions failed
            if [ -n "$LHCI_EXIT_CODE" ] && [ "$LHCI_EXIT_CODE" != "0" ]; then
              WARNING_NOTE="_*‚ö†Ô∏è Performance scores can vary due to network conditions. Consider re-running the job or testing with [PageSpeed Insights](https://pagespeed.web.dev/) on the production URL for more stable results.*_"
            else
              WARNING_NOTE=""
            fi
            
            # Create comment body
            COMMENT_BODY="## üö¶ Lighthouse CI Results
            | Category | Score |
            |----------|-------|
            | $PERF_EMOJI **Performance** | **${PERF}%** |
            | $A11Y_EMOJI **Accessibility** | **${A11Y}%** |
            | $BP_EMOJI **Best Practices** | **${BP}%** |
            | $SEO_EMOJI **SEO** | **${SEO}%** |
            ### Core Web Vitals
            - **LCP:** ${LCP}
            - **TBT:** ${TBT}
            - **CLS:** ${CLS}
            
            $REPORT_LINK
            ---
            _Tested on: Homepage (/) ‚Ä¢ Median of 3 runs ‚Ä¢ Commit: \`${GITHUB_SHA:0:7}\`_
            $WARNING_NOTE"
            # Find existing Lighthouse comment
            COMMENT_ID=$(gh api \
              "repos/${{ github.repository }}/issues/${PR_NUMBER}/comments" \
              --jq '.[] | select(.body | startswith("## üö¶ Lighthouse CI Results")) | .id' \
              | head -1)
            if [ -n "$COMMENT_ID" ]; then
              # Update existing comment
              echo "Updating existing comment ID: $COMMENT_ID"
              gh api \
                --method PATCH \
                "repos/${{ github.repository }}/issues/comments/$COMMENT_ID" \
                -f body="$COMMENT_BODY"
            else
              # Create new comment
              echo "Creating new comment"
              gh api \
                --method POST \
                "repos/${{ github.repository }}/issues/${PR_NUMBER}/comments" \
                -f body="$COMMENT_BODY"
            fi
          else
            echo "No Lighthouse report found"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Upload Lighthouse results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-results
          path: .lighthouseci